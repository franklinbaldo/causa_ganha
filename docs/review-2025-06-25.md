### 1 · A crítica procede?

| # | Área                            | Justeza             | Diagnóstico-relâmpago                                                                                                                                                                          |
| - | ------------------------------- | ------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1 | **Over-engineering de CI**      | **Sim**             | Há **6 workflows** («01\_collect» a «04\_backup\_r2» + «test» + manual) – todos individuais. A maioria poderia rodar em sequência no mesmo job-matrix, reduzindo cold-starts e YAML duplicado. |
| 2 | **Schema inline no `__init__`** | **Sim**             | `CausaGanhaDB._initialize_schema()` executa DDL toda vez que conecta, o que inviabiliza versionamento e rollback.                                                                              |
| 3 | **JSON como VARCHAR**           | **Parcial**         | Hoje o schema usa o tipo **`JSON`** nativo de DuckDB. O problema real não é o tipo, e sim a *normalização*: times, advogados e partes continuam embalados num JSON → `JOIN`s custosos.         |
| 4 | **`except Exception:`**         | **Sim**             | Fluxos de ETL ainda têm blocos genéricos (ex.: `except Exception as e:` no extrator), que abafam bugs silenciosos.                                                                             |
| 5 | **Logging com `f"..."`**        | **Sim**             | A base usa f-strings em loggers («Processing JSON file…»), perdendo *lazy evaluation* e gerando overhead no DEBUG off.                                                                         |
| 6 | **Governança/LGPD**             | **Sim**             | Nada no pipeline sanitiza CPFs ou dados sensíveis apreendidos nos PDFs – risco real se outro tribunal publicar informação de saúde.                                                            |
| 7 | **Gemini = SPOF**               | **Sim**             | Todo parsing depende da chamada `extractor.py`→Gemini; fallback inexistente.                                                                                                                   |
| 8 | **TrueSkill binário**           | **Sim, mas nuance** | O modelo assume vitória 0/1; decisões parciais (ex.: “provido em parte”) são mapeadas arbitrariamente. Isso distorce ranking.                                                                  |

### 2 · Transforme cada dor em ação concreta

| Pri    | Ação concreta                           | Como fazer                                                                                                                                                                  | Esforço |
| ------ | --------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------- |
| **P0** | **Fusionar Workflows**                  | Crie *composite-action* `pipeline.yml` com jobs encadeados: **collect → archive → extract → update → backup**. Use `needs:` e artefatos compartilhados; apague YAMLs 01–04. | ½ dia   |
| **P0** | **Migrations versionadas**              | Mova todo DDL para `migrations/001_init.sql`, `002_add_index.sql`… Rode `duckdb -s migrations/*.sql` no entrypoint; trave versão no repo.                                   | 1 dia   |
| **P0** | **Remover `except Exception`**          | Busque `grep -R "except Exception"`; substitua por erros específicos (`FileNotFoundError`, `JSONDecodeError`, `DuckDBError`). Falhou? Deixe propagar e quebre o CI.         | 2-3 h   |
| **P0** | **Refatorar logging**                   | Refatore para `logger.info("Processing JSON file %s", json_path.name)`. Rode `ruff` com regra `TRY003` habilitada.                                                          | 2 h     |
| **P1** | **Tabela de dimensão `advogados`**      | Crie tabelas `advogado(id, nome, oab)` e `parte(id, nome)`; troque colunas JSON ↔ FK; gere view legacy para não quebrar código.                                             | 1,5 dia |
| **P1** | **Feature-flag de motor LLM**           | Abstraia chamadas em `llm_backend.py` com interface `extract(text)`. Implemente mock local (`spacy+regex`) para testes e toggle por env var.                                | 1 dia   |
| **P1** | **Classificador de resultado granular** | Mude `resultado_partida` para enum `{win_a, win_b, partial_a, partial_b, draw}`. Ajuste cálculo TrueSkill para ponderar `partial_*` como 0.7 × vitória.                     | 1 dia   |
| **P2** | **Anonymizer LGPD**                     | Pós-extração: aplique regex de CPF/CNPJ e substitua por hash. Guarde chaves SHA-256 em tabela separada com controle de acesso.                                              | 2 dias  |
| **P2** | **Caching de respostas Gemini**         | Salve JSON bruto + hash do prompt. Se 429/500, re-use cache; se pricing mudar, troque endpoint e siga.                                                                      | ½ dia   |
| **P2** | **Dashboard MVP**                       | Gere `ranking_atual.csv` + gráfico simples com `plotly` e hospede no GitHub Pages. Nada de Cloudflare R2 nesta fase.                                                        | 1 dia   |

### 3 · Roadmap enxuto (30-dias)

| Semana | Meta        | Deliverable                                                                                   |
| ------ | ----------- | --------------------------------------------------------------------------------------------- |
| **1**  | Hardening   | Workflows fusionados, logging fix, exceções específicas; CI verde.                            |
| **2**  | Data-layer  | Migrations SQL + normalização `advogados/partes`; backfill.                                   |
| **3**  | Resiliência | Cache LLM + mock extractor; flag de motor; primeiros testes sem Gemini.                       |
| **4**  | MVP público | Ranking top-50, CSV completo para download, README que explica margem de erro e anonimização. |

### 4 · TL;DR brutal

> **CausaGanha** está saudável, mas obeso. Corte YAML, versione schema, pare de engolir exceções e normalize dados. Em quatro semanas você entrega um MVP robusto e transparente – depois pense em ser “AWS da advocacia”.
